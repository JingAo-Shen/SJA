<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Servlet 容器与 Servlet/JSP（零基础详细版）</title>
  <style>
    :root { --bg:#f7f9ff; --card:#fff; --primary:#0b6bcb; --muted:#4a5568; --border:#e2e8f0; }
    body { margin:0; font-family:"Segoe UI","PingFang SC",system-ui; color:#0f172a; background:var(--bg); }
    header { padding:24px 16px 8px; text-align:center; }
    header h1 { margin:0 0 8px; font-size:28px; }
    header p { margin:0; color:var(--muted); }
    main { max-width:1100px; margin:0 auto; padding:0 16px 32px; display:grid; gap:16px; }
    section { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px 18px; box-shadow:0 8px 25px rgba(15,23,42,0.08); }
    h2 { margin:0 0 10px; color:var(--primary); font-size:20px; }
    h3 { margin:0 0 8px; font-size:17px; }
    p { margin:6px 0; color:var(--muted); line-height:1.6; }
    ul, ol { margin:6px 0 0 20px; color:var(--muted); line-height:1.6; padding-left:14px; }
    pre { background:#0b2545; color:#e2e8f0; padding:10px 12px; border-radius:10px; overflow-x:auto; font-size:13px; line-height:1.5; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    a { color:var(--primary); text-decoration:none; }
    .pill { display:inline-block; padding:2px 10px; border:1px solid var(--border); border-radius:999px; margin-right:6px; background:rgba(11,107,203,0.08); font-size:12px; }
    .back { text-align:right; margin-top:6px; }
  </style>
</head>
<body>
  <header>
    <h1>Servlet 容器与 Servlet/JSP（零基础详细版）</h1>
    <p>目标：会在 Tomcat 上编写表单处理 Servlet，理解生命周期与 Filter，使用 JSP 输出并对比 JSON。</p>
    <div class="back"><a href="index.html">← 返回一级入口</a></div>
  </header>

  <main>
    <section>
      <h2>学习目标与前置</h2>
      <p><span class="pill">建议用时：60-90 分钟</span><span class="pill">准备：已安装 JDK、Maven，Tomcat（外置）或 Maven Tomcat 插件</span></p>
      <ul>
        <li>理解 Servlet 容器职责，内嵌 vs 外置差异。</li>
        <li>编写 TodoServlet 处理 GET/POST。</li>
        <li>编写 Filter 记录请求日志；JSP 输出页面并对比 JSON。</li>
      </ul>
    </section>

    <section>
      <h2>Step 1：创建 Maven Web 项目</h2>
<pre><code class="language-bash">mvn archetype:generate ^
  -DgroupId=demo ^
  -DartifactId=servlet-demo ^
  -DarchetypeArtifactId=maven-archetype-webapp ^
  -DinteractiveMode=false
cd servlet-demo</code></pre>
      <p>目录要点：<code>src/main/java</code> 写 Servlet/Filter，<code>src/main/webapp</code> 放 JSP 和静态资源，<code>pom.xml</code> 定义依赖与插件。</p>
    </section>

    <section>
      <h2>Step 2：添加 Servlet API 依赖与 Tomcat 插件</h2>
<pre><code class="language-xml">&lt;dependencies&gt;
  &lt;dependency&gt;
    &lt;groupId&gt;jakarta.servlet&lt;/groupId&gt;
    &lt;artifactId&gt;jakarta.servlet-api&lt;/artifactId&gt;
    &lt;version&gt;5.0.0&lt;/version&gt;
    &lt;scope&gt;provided&lt;/scope&gt;
  &lt;/dependency&gt;
&lt;/dependencies&gt;

&lt;build&gt;
  &lt;plugins&gt;
    &lt;plugin&gt;
      &lt;groupId&gt;org.apache.tomcat.maven&lt;/groupId&gt;
      &lt;artifactId&gt;tomcat7-maven-plugin&lt;/artifactId&gt;
      &lt;version&gt;2.2&lt;/version&gt;
      &lt;configuration&gt;
        &lt;path&gt;/servlet-demo&lt;/path&gt;
        &lt;port&gt;8080&lt;/port&gt;
      &lt;/configuration&gt;
    &lt;/plugin&gt;
  &lt;/plugins&gt;
&lt;/build&gt;</code></pre>
      <p>说明：scope=provided 表示运行时由容器提供；Tomcat 插件方便本地跑。</p>
    </section>

    <section>
      <h2>Tomcat 介绍与工作原理</h2>
      <p>Tomcat 是 Apache 软件基金会维护的开源 Servlet/JSP 容器，负责解析 HTTP/HTTPS 请求、分发线程、执行 Servlet 代码并返回响应。它提供了 Web Server（连接器）与 Servlet Engine（容器）两部分：前者监听端口接收请求，后者根据 URL 映射把请求交给具体的 Servlet、Filter、JSP。</p>
      <ul>
        <li><strong>启动与目录结构</strong>：bin 目录存放启动脚本，conf 内包括 server.xml（端口、虚拟主机）、web.xml（全局 Servlet 映射）、context.xml（数据源等）；webapps 下的每个子目录或 war 文件对应一个 Web 应用。</li>
        <li><strong>请求处理流程</strong>：Connector 读取请求 → 创建 HttpServletRequest/Response 对象 → 依次经过 Filter 链 → 调用 Servlet service/doGet/doPost → 可转发到 JSP → 生成响应并写回客户端。</li>
        <li><strong>线程与会话</strong>：每个请求默认由线程池处理，可通过 server.xml 调整最大线程数；容器负责创建 HttpSession，提供黏性会话、持久化等策略。</li>
        <li><strong>部署方式</strong>：支持解压 war、保留 war 直接热部署、或者通过 Maven/Gradle 插件远程发布；日志位于 logs 目录，可通过 catalina.out、localhost_access_log 查询运行状态。</li>
        <li><strong>常见配置</strong>：server.xml 中的 &lt;Connector&gt; 可切换 NIO/NIO2/Apr 协议，context.xml 能声明 JNDI 数据源、环境变量，web.xml 可统一配置编码过滤器、安全约束。</li>
      </ul>
      <p>理解这些概念后，在本地只需把 war 放入 <code>webapps</code> 并启动 Tomcat，即可用浏览器验证 Servlet/JSP 行为，调试和线上部署流程也都会保持一致。</p>
    </section>

    <section>
      <h2>在 IntelliJ IDEA 中使用 Tomcat</h2>
      <ol>
        <li><strong>准备工作</strong>：确认使用 IntelliJ IDEA Ultimate（社区版没有应用服务器集成功能），并提前下载好独立的 Tomcat。导入或创建 Maven Web 项目后检查 <code>pom.xml</code> 中存在 war 打包配置。</li>
        <li><strong>创建运行配置</strong>：依次点击 Run &gt; Edit Configurations &gt; “+” &gt; Tomcat Server &gt; Local，首次创建会提示选择 Tomcat 安装目录（即解压目录）。IDEA 会自动识别 bin、conf 并创建默认配置。</li>
        <li><strong>部署应用</strong>：切换到 Deployment 标签，点击 “+” 选择 “Artifact” 或 “war exploded”，一般建议选择 <code>project-name:war exploded</code> 方便热部署；Context path 建议与项目名一致（如 <code>/servlet-demo</code>）。</li>
        <li><strong>调优与调试</strong>：在 Server 标签可修改端口、JRE、VM options；在 “Before launch” 中添加 “Build” 或 “Build Artifacts” 确保每次运行前自动编译。点击 Debug 运行即可在 Servlet 的 <code>doGet</code>/<code>doPost</code> 设置断点单步排查。</li>
        <li><strong>验证与热部署</strong>：启动后 IDEA 控制台会输出 Tomcat 日志，浏览器访问 <code>http://localhost:8080/servlet-demo</code> 进行验证。修改 JSP 或类后点击 “Update classes and resources” 可热更新，避免频繁重启。</li>
      </ol>
      <p>IDEA 对 Tomcat 的一体化支持覆盖了启动、调试、日志查看、热部署和远程部署（可在 Deployment 中配置 SFTP/FTP）。熟练这些操作可以显著缩短“改代码 → 构建 → 启动 → 验证”的迭代周期。</p>
    </section>

    <section>
      <h2>Step 3：编写 Servlet 与 Filter</h2>
      <pre class="mermaid">
flowchart LR
  A[浏览器请求] --> B[Filter 日志/鉴权]
  B --> C[Servlet 处理 GET/POST]
  C --> D1[JSON 响应]
  C --> D2[JSP 渲染转发]
</pre>
<pre><code class="language-java">// src/main/java/demo/web/TodoServlet.java
@WebServlet("/todos")
public class TodoServlet extends HttpServlet {
  private final List&lt;String&gt; todos = new ArrayList<>();

  @Override
  protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws IOException {
    req.setCharacterEncoding("UTF-8");
    String title = req.getParameter("title");
    todos.add(title);
    resp.setContentType("application/json;charset=UTF-8");
    resp.getWriter().write("{\"size\":" + todos.size() + "}");
  }

  @Override
  protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws IOException {
    resp.setContentType("application/json;charset=UTF-8");
    resp.getWriter().write(new ObjectMapper().writeValueAsString(todos));
  }
}</code></pre>
<pre><code class="language-java">// src/main/java/demo/web/LogFilter.java
@WebFilter("/*")
public class LogFilter implements Filter {
  public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain)
      throws IOException, ServletException {
    HttpServletRequest r = (HttpServletRequest) req;
    long t0 = System.nanoTime();
    System.out.println("REQ " + r.getMethod() + " " + r.getRequestURI());
    chain.doFilter(req, res);
    System.out.println("COST " + (System.nanoTime() - t0)/1_000_000 + "ms");
  }
}</code></pre>
    </section>

    <section>
      <h2>Step 4：编写 JSP 对比输出</h2>
<pre><code class="language-html">&lt;%-- src/main/webapp/index.jsp --%&gt;
&lt;%@ page contentType="text/html;charset=UTF-8" language="java" %&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;body&gt;
  &lt;h3&gt;JSP 渲染 todos&lt;/h3&gt;
  &lt;ul&gt;
    &lt;% java.util.List list = (java.util.List) request.getAttribute("todos"); %&gt;
    &lt;% if(list != null) { for(Object t: list){ %&gt;
      &lt;li&gt;&lt;%= t %&gt;&lt;/li&gt;
    &lt;% }} %&gt;
  &lt;/ul&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
      <p>对比：JSP 用于服务端渲染；JSON 用于前后端分离，现代项目更常用后者。</p>
    </section>

    <section>
      <h2>Step 5：运行</h2>
      <ul>
        <li>用插件：<code>mvn tomcat7:run</code>，访问 <code>http://localhost:8080/servlet-demo/todos</code>。</li>
        <li>外置 Tomcat：<code>mvn package</code> 生成 war，放入 Tomcat webapps，启动后访问同路径。</li>
      </ul>
    </section>

    <section>
      <h2>操作步骤（课堂演示）</h2>
      <ol>
        <li>POST /todos 新增一条，刷新 GET /todos 查看 JSON 列表。</li>
        <li>在 Filter 中打印耗时，刷新查看日志。</li>
        <li>访问 JSP 页面，展示列表，说明 JSON/前后端分离的优势。</li>
      </ol>
    </section>

    <section>
      <h2>常见问题与排查</h2>
      <ul>
        <li><strong>404</strong>：检查 @WebServlet 路径或 web.xml 映射。</li>
        <li><strong>编码问题</strong>：POST 表单需 <code>req.setCharacterEncoding("UTF-8")</code>，响应设 <code>application/json;charset=UTF-8</code>。</li>
        <li><strong>端口被占用</strong>：修改插件 port，或关闭占用程序。</li>
      </ul>
    </section>

    <section>
      <h2>课堂练习</h2>
      <ul>
        <li>添加删除接口：POST /todos?action=del&index=0 或 DELETE /todos/{id}。</li>
        <li>在 Filter 中加入简单鉴权：若 header 不含 X-Token，则 401。</li>
      </ul>
    </section>

    <section>
      <h2>课后巩固</h2>
      <ul>
        <li>将 Filter 日志改为“时间 | 方法 | 路径 | 耗时 ms”格式。</li>
        <li>在 JSP 页面加入表单，提交给 Servlet，再回显结果。</li>
      </ul>
    </section>
  </main>
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true, theme: 'neutral' });
  </script>
</body>
</html>
